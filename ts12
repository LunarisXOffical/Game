local Junkie = loadstring(game:HttpGet("https://jnkie.com/sdk/library.lua"))()
Junkie.service = "Loader"
Junkie.identifier = "20"
Junkie.provider = "WorkInk"

-- Your main script URL
local MAIN_SCRIPT_URL = "https://api.jnkie.com/api/v1/luascripts/public/ef8ff69b360ed94227e911b3cb9dea13cbfe99fb118eb524b3e69d814a3b4406/download"

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local HttpService = game:GetService("HttpService")

-- Flag to track if main script is loaded
getgenv().SCRIPT_LOADED = false

local Icons = {
	Shield = "rbxassetid://105619007041452",
	Loading = "rbxassetid://116535712789945",
	Lock = "rbxassetid://114355063515473",
	Key = "rbxassetid://93569468678423",
	Check = "rbxassetid://119783053916823",
	CheckCircle = "rbxassetid://10709790644",
	XCircle = "rbxassetid://10747384394",
	Warning = "rbxassetid://130226573962640",
	Globe = "rbxassetid://10734950309",
	Info = "rbxassetid://94529541997278",
	ExternalLink = "rbxassetid://71038734318580",
	Copy = "rbxassetid://107485544510830",
	Spinner = "rbxassetid://10709767827",
	Database = "rbxassetid://114209748010261",
	Sparkles = "rbxassetid://10709767827",
	ErrorFolder = "rbxassetid://113312905787220",
	Candy = "rbxassetid://10709767827",
	JunkieNewIcon = "rbxassetid://75038032192167"
}

local function hasFileSystemSupport()
    local hasWritefile = pcall(function() return type(writefile) == "function" end)
    local hasReadfile = pcall(function() return type(readfile) == "function" end)
    local hasIsfile = pcall(function() return type(isfile) == "function" end)
    return hasWritefile and hasReadfile and hasIsfile
end

local fileSystemSupported = hasFileSystemSupport()

local function saveVerifiedKey(key)
    if not fileSystemSupported then return false end
    local ok = pcall(function()
        writefile("lunascript_verified_key.txt", key)
    end)
    return ok
end

local function loadVerifiedKey()
    if not fileSystemSupported then 
        return nil 
    end
    
    local ok, content = pcall(function()
        return readfile("lunascript_verified_key.txt")
    end)
    
    if not ok or not content then 
        return nil 
    end
    return content
end

local function clearSavedKey()
    if not fileSystemSupported then return false end
    local ok = pcall(function() delfile("lunascript_verified_key.txt") end)
    return ok
end

local Configuration = {
	ScreenGuiName = "JunkieKeySystem",
	Window = {Size = UDim2.new(0, 333, 0, 500)},
	Colors = {
		Bg = Color3.fromRGB(12, 12, 12),
		Primary = Color3.fromRGB(59, 130, 246),
		PrimaryDark = Color3.fromRGB(37, 99, 235),
		StatusIdle = Color3.fromRGB(249, 115, 22),
		StatusSuccess = Color3.fromRGB(16, 185, 129),
		StatusError = Color3.fromRGB(239, 68, 68),
		StatusVerifying = Color3.fromRGB(59, 130, 246),
		StatusWarning = Color3.fromRGB(254, 188, 46),
		TextMain = Color3.fromRGB(255, 255, 255),
		TextSec = Color3.fromRGB(161, 161, 170),
		TextMuted = Color3.fromRGB(113, 113, 122),
		Border = Color3.fromRGB(255, 255, 255),
		TrafficRed = Color3.fromRGB(255, 95, 87),
		TrafficYellow = Color3.fromRGB(254, 188, 46),
		TrafficGreen = Color3.fromRGB(40, 200, 64),
		Success = Color3.fromRGB(50, 205, 110),
		Error = Color3.fromRGB(245, 70, 90),
		Warning = Color3.fromRGB(255, 200, 50)
	},
	BorderTransparency = 0.15,
	Animations = {
		VeryFast = 0.1,
		Fast = 0.2,
		Medium = 0.4,
		Slow = 0.5,
		VerySlow = 0.6,
		Bounce = 0.6
	},
	Fonts = {
		Title = 24,
		Subtitle = 12,
		Button = 14,
		Input = 16,
		Body = 13,
		Small = 11,
		Tiny = 12
	}
}

local Utils = {}

Utils.Tween = function(obj, props, time, style, dir)
	local t =
		TweenService:Create(
		obj,
		TweenInfo.new(time or 0.3, style or Enum.EasingStyle.Quint, dir or Enum.EasingDirection.Out),
		props
	)
	t:Play()
	return t
end

Utils.CreateCorner = function(parent, radius)
	local corner = Instance.new("UICorner")
	corner.CornerRadius = UDim.new(0, radius or Configuration.CornerRadius)
	corner.Parent = parent
	return corner
end

Utils.Round = function(obj, radius)
	local c = Instance.new("UICorner")
	c.CornerRadius = UDim.new(0, radius or 12)
	c.Parent = obj
	return c
end

Utils.TweenBack = function(instance, properties, duration)
	return Utils.Tween(instance, properties, duration, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
end

Utils.CreateStroke = function(parent, color, thickness, transparency)
	local stroke = Instance.new("UIStroke")
	stroke.Color = color or Configuration.Colors.Border
	stroke.Thickness = thickness or 1
	stroke.Transparency = transparency or 0.77
	stroke.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	stroke.Parent = parent
	return stroke
end

Utils.Stroke = function(obj, color, thick, trans)
	local s = Instance.new("UIStroke")
	s.Color = color or Color3.new(1, 1, 1)
	s.Thickness = thick or 1
	s.Transparency = trans or 0.9
	s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	s.Parent = obj
	return s
end

Utils.CreateGradient = function(parent, color1, color2, rotation)
	local gradient = Instance.new("UIGradient")
	gradient.Color =
		ColorSequence.new(
		{
			ColorSequenceKeypoint.new(0, color1),
			ColorSequenceKeypoint.new(1, color2)
		}
	)
	gradient.Rotation = rotation or 300
	gradient.Parent = parent
	return gradient
end

local function SetBlur(enabled)
	local blur = Lighting:FindFirstChild("JunkieBlur")
	if enabled then
		if not blur then
			blur = Instance.new("BlurEffect")
			blur.Name = "JunkieBlur"
			blur.Size = 0
			blur.Parent = Lighting
		end
		Utils.Tween(blur, {Size = 24}, Configuration.Animations.Bounce)
	elseif blur then
		Utils.Tween(blur, {Size = 0}, Configuration.Animations.Medium)
		task.delay(
			0.4,
			function()
				blur:Destroy()
			end
		)
	end
end

local ToastSystem = {ActiveToasts = {}, MaxToasts = 3, ToastSpacing = 10}

ToastSystem.Create = function(parent, message, toastType, duration, statusCode)
	local colors = {
		success = Configuration.Colors.Success,
		error = Configuration.Colors.Error,
		warning = Configuration.Colors.Warning,
		info = Configuration.Colors.Primary
	}
	local icons = {
		success = Icons.CheckCircle,
		error = Icons.ErrorFolder,
		warning = Icons.Warning,
		info = Icons.Info
	}
	local toastColor = colors[toastType] or colors.Bg
	local toastIcon = icons[toastType] or nil
	if #ToastSystem.ActiveToasts >= ToastSystem.MaxToasts then
		local oldest = table.remove(ToastSystem.ActiveToasts, 1)
		if oldest and oldest.Parent then
			oldest:Destroy()
		end
	end
	local toastHeight = 56
	local toast = Instance.new("Frame")
	toast.Name = tick()
	toast.Size = UDim2.new(0, 0, 0, toastHeight)
	toast.Position = UDim2.new(0.5, 0, 0, 20)
	toast.AnchorPoint = Vector2.new(0.5, 0)
	toast.BackgroundColor3 = Configuration.Colors.Bg
	toast.BackgroundTransparency = 0.5
	toast.BorderSizePixel = 0
	toast.ZIndex = 300
	toast.ClipsDescendants = true
	toast.Parent = parent
	Utils.Round(toast, 14)
	Utils.CreateStroke(toast, toastColor, 1, 0.1)
	Utils.CreateGradient(toast, Configuration.Colors.Bg, Configuration.Colors.Bg, 1)
	local iconBg = Instance.new("Frame")
	iconBg.Name = "IconBg"
	iconBg.Size = UDim2.new(0, 36, 0, 36)
	iconBg.Position = UDim2.new(0, 12, 0.5, 0)
	iconBg.AnchorPoint = Vector2.new(0, 0.5)
	iconBg.BackgroundColor3 = toastColor
	iconBg.BackgroundTransparency = 0.85
	iconBg.BorderSizePixel = 0
	iconBg.ZIndex = 301
	iconBg.Parent = toast
	Utils.Round(iconBg, 18)
	local icon = Instance.new("ImageLabel")
	icon.Name = "Icon"
	icon.Size = UDim2.new(0, 20, 0, 20)
	icon.Position = UDim2.new(0.5, 0, 0.5, 0)
	icon.AnchorPoint = Vector2.new(0.5, 0.5)
	icon.BackgroundTransparency = 1
	icon.Image = toastIcon
	icon.ImageColor3 = toastColor
	icon.ZIndex = 302
	icon.Parent = iconBg
	local textContainer = Instance.new("Frame")
	textContainer.Name = "TextContainer"
	textContainer.Size = UDim2.new(1, statusCode and -110 or -60, 1, 0)
	textContainer.Position = UDim2.new(0, 56, 0, 0)
	textContainer.BackgroundTransparency = 1
	textContainer.ZIndex = 301
	textContainer.Parent = toast
	local text = Instance.new("TextLabel")
	text.Name = "Message"
	text.Size = UDim2.new(1, 0, 1, 0)
	text.BackgroundTransparency = 1
	text.Text = message or ""
	text.TextColor3 = Configuration.Colors.TextMain
	text.TextSize = Configuration.Fonts.Body
	text.Font = Enum.Font.GothamMedium
	text.TextXAlignment = Enum.TextXAlignment.Left
	text.TextYAlignment = Enum.TextYAlignment.Center
	text.TextWrapped = true
	text.ZIndex = 301
	text.Parent = textContainer
	if statusCode then
		local statusBadge = Instance.new("Frame")
		statusBadge.Name = "StatusBadge"
		statusBadge.Size = UDim2.new(0, 44, 0, 28)
		statusBadge.Position = UDim2.new(1, -12, 0.5, 0)
		statusBadge.AnchorPoint = Vector2.new(1, 0.5)
		statusBadge.BackgroundColor3 = toastColor
		statusBadge.BackgroundTransparency = 0.8
		statusBadge.BorderSizePixel = 0
		statusBadge.ZIndex = 301
		statusBadge.Parent = toast
		Utils.Round(statusBadge, 8)
		Utils.CreateStroke(statusBadge, toastColor, 1, Configuration.BorderTransparency)
		local statusCodeLabel = Instance.new("TextLabel")
		statusCodeLabel.Name = "StatusCode"
		statusCodeLabel.Size = UDim2.new(1, 0, 1, 0)
		statusCodeLabel.BackgroundTransparency = 1
		statusCodeLabel.Text = tostring(statusCode)
		statusCodeLabel.TextColor3 = toastColor
		statusCodeLabel.TextSize = Configuration.Fonts.Small
		statusCodeLabel.Font = Enum.Font.GothamBold
		statusCodeLabel.ZIndex = 302
		statusCodeLabel.Parent = statusBadge
	end
	table.insert(ToastSystem.ActiveToasts, toast)
	ToastSystem.RepositionToasts()
	local targetWidth = 320
	Utils.TweenBack(toast, {Size = UDim2.new(0, targetWidth, 0, toastHeight)}, Configuration.Animations.Medium)
	task.delay(
		duration or 3.5,
		function()
			if toast.Parent then
				Utils.Tween(
					toast,
					{
						Position = UDim2.new(0.5, 0, 0, -80),
						BackgroundTransparency = 1
					},
					Configuration.Animations.Medium
				)
				for i, t in ipairs(ToastSystem.ActiveToasts) do
					if t == toast then
						table.remove(ToastSystem.ActiveToasts, i)
						break
					end
				end
				task.wait(Configuration.Animations.Medium)
				toast:Destroy()
				ToastSystem.RepositionToasts()
			end
		end
	)
	return toast
end

ToastSystem.RepositionToasts = function()
	for i, toast in ipairs(ToastSystem.ActiveToasts) do
		local targetY = 20 + ((i - 1) * (60 + ToastSystem.ToastSpacing))
		Utils.Tween(toast, {Position = UDim2.new(0.5, 0, 0, targetY)}, Configuration.Animations.Medium)
	end
end

-- Enhanced loading screen that matches key system UI
local function createLoadingScreen()
    local coreGui = game:GetService("CoreGui")
    
    -- Remove existing loading screen
    local existing = coreGui:FindFirstChild("LoadingScreenUI")
    if existing then
        existing:Destroy()
    end
    
    -- Create main loading screen
    local loadingScreen = Instance.new("ScreenGui")
    loadingScreen.Name = "LoadingScreenUI"
    loadingScreen.ResetOnSpawn = false
    loadingScreen.Parent = coreGui
    
    -- Add blur effect
    SetBlur(true)
    
    -- Main container (matches key system design)
    local mainContainer = Instance.new("Frame")
    mainContainer.Size = Configuration.Window.Size
    mainContainer.Position = UDim2.new(0.5, 0, 0.5, 60)
    mainContainer.AnchorPoint = Vector2.new(0.5, 0.5)
    mainContainer.BackgroundColor3 = Configuration.Colors.Bg
    mainContainer.BackgroundTransparency = 0.2
    mainContainer.ClipsDescendants = true
    mainContainer.Parent = loadingScreen
    
    Utils.Round(mainContainer, 24)
    Utils.Stroke(mainContainer, Color3.new(1, 1, 1), 1, 0.92)
    
    -- Glass effect
    local glass = Instance.new("Frame")
    glass.Size = UDim2.fromScale(1, 1)
    glass.BackgroundColor3 = Color3.new(1, 1, 1)
    glass.BackgroundTransparency = 0.985
    glass.ZIndex = 0
    glass.Parent = mainContainer
    Utils.Round(glass, 24)
    
    -- Top bar with traffic lights
    local bar = Instance.new("Frame")
    bar.Size = UDim2.new(1, 0, 0, 54)
    bar.BackgroundTransparency = 1
    bar.Parent = mainContainer
    
    local dots = Instance.new("Frame")
    dots.Size = UDim2.new(0, 54, 0, 12)
    dots.Position = UDim2.new(0, 20, 0.5, 0)
    dots.AnchorPoint = Vector2.new(0, 0.5)
    dots.BackgroundTransparency = 1
    dots.Parent = bar
    
    local dColors = {
        Configuration.Colors.TrafficRed,
        Configuration.Colors.TrafficYellow,
        Configuration.Colors.TrafficGreen
    }
    
    for i, c in ipairs(dColors) do
        local d = Instance.new("Frame")
        d.Size = UDim2.fromOffset(12, 12)
        d.Position = UDim2.fromOffset((i - 1) * 18, 0)
        d.BackgroundColor3 = c
        d.BorderSizePixel = 0
        d.Parent = dots
        Utils.Round(d, 6)
    end
    
    local titleText = Instance.new("TextLabel")
    titleText.Size = UDim2.new(1, 0, 1, 0)
    titleText.Text = "LOADING"
    titleText.TextColor3 = Color3.new(1, 1, 1)
    titleText.TextTransparency = 0.7
    titleText.TextSize = 10
    titleText.Font = Enum.Font.GothamBold
    titleText.BackgroundTransparency = 1
    titleText.Parent = bar
    
    -- Content area
    local content = Instance.new("Frame")
    content.Size = UDim2.new(1, 0, 1, -54)
    content.Position = UDim2.new(0, 0, 0, 54)
    content.BackgroundTransparency = 1
    content.Parent = mainContainer
    
    -- Logo container (matches key system)
    local logoContainer = Instance.new("Frame")
    logoContainer.Size = UDim2.fromOffset(80, 80)
    logoContainer.Position = UDim2.new(0.5, -40, 0.2, -40)
    logoContainer.AnchorPoint = Vector2.new(0.5, 0.5)
    logoContainer.BackgroundColor3 = Configuration.Colors.Primary
    logoContainer.Parent = content
    Utils.Round(logoContainer, 20)
    
    local grad = Instance.new("UIGradient")
    grad.Color = ColorSequence.new(Configuration.Colors.Primary, Configuration.Colors.PrimaryDark)
    grad.Rotation = 45
    grad.Parent = logoContainer
    
    local sIcon = Instance.new("ImageLabel")
    sIcon.Size = UDim2.fromScale(0.6, 0.6)
    sIcon.Position = UDim2.fromScale(0.5, 0.5)
    sIcon.AnchorPoint = Vector2.new(0.5, 0.5)
    sIcon.Image = Icons.JunkieNewIcon
    sIcon.ScaleType = Enum.ScaleType.Fit
    sIcon.BackgroundTransparency = 1
    sIcon.Parent = logoContainer
    
    -- Loading spinner
    local spinnerContainer = Instance.new("Frame")
    spinnerContainer.Size = UDim2.fromOffset(100, 100)
    spinnerContainer.Position = UDim2.new(0.5, -50, 0.5, -50)
    spinnerContainer.AnchorPoint = Vector2.new(0.5, 0.5)
    spinnerContainer.BackgroundTransparency = 1
    spinnerContainer.Parent = content
    
    local outerCircle = Instance.new("Frame")
    outerCircle.Size = UDim2.fromOffset(80, 80)
    outerCircle.Position = UDim2.new(0.5, -40, 0.5, -40)
    outerCircle.AnchorPoint = Vector2.new(0.5, 0.5)
    outerCircle.BackgroundTransparency = 1
    outerCircle.Parent = spinnerContainer
    
    local innerCircle = Instance.new("Frame")
    innerCircle.Size = UDim2.fromOffset(60, 60)
    innerCircle.Position = UDim2.new(0.5, -30, 0.5, -30)
    innerCircle.AnchorPoint = Vector2.new(0.5, 0.5)
    innerCircle.BackgroundColor3 = Configuration.Colors.Primary
    innerCircle.BackgroundTransparency = 0.9
    innerCircle.Parent = outerCircle
    Utils.Round(innerCircle, 30)
    
    -- Animated spinner segments
    local segments = 8
    local segmentAngle = 360 / segments
    
    for i = 1, segments do
        local segment = Instance.new("Frame")
        segment.Size = UDim2.new(0, 6, 0, 20)
        segment.Position = UDim2.new(0.5, -3, 0, -10)
        segment.AnchorPoint = Vector2.new(0.5, 0.5)
        segment.BackgroundColor3 = Configuration.Colors.Primary
        segment.Rotation = (i - 1) * segmentAngle
        segment.Parent = outerCircle
        Utils.Round(segment, 3)
        
        -- Animate opacity
        task.spawn(function()
            while segment and segment.Parent do
                local alpha = math.abs(math.sin(tick() * 2 + i * 0.5))
                segment.BackgroundTransparency = 0.3 + (alpha * 0.7)
                task.wait()
            end
        end)
    end
    
    -- Loading text
    local loadingText = Instance.new("TextLabel")
    loadingText.Size = UDim2.new(0.8, 0, 0, 30)
    loadingText.Position = UDim2.new(0.5, 0, 0.8, 0)
    loadingText.AnchorPoint = Vector2.new(0.5, 0.5)
    loadingText.BackgroundTransparency = 1
    loadingText.Text = "LOADING SCRIPT..."
    loadingText.TextColor3 = Configuration.Colors.TextMain
    loadingText.TextSize = Configuration.Fonts.Body
    loadingText.Font = Enum.Font.GothamMedium
    loadingText.Parent = content
    
    -- Animate dots in text
    task.spawn(function()
        local dotIndex = 1
        while loadingText and loadingText.Parent do
            loadingText.Text = "LOADING SCRIPT" .. string.rep(".", dotIndex)
            dotIndex = dotIndex % 3 + 1
            task.wait(0.5)
        end
    end)
    
    -- Animate entrance
    mainContainer.Position = UDim2.new(0.5, 0, 0.5, 100)
    mainContainer.BackgroundTransparency = 1
    Utils.Tween(
        mainContainer,
        {
            Position = UDim2.new(0.5, 0, 0.5, 0),
            BackgroundTransparency = 0.2
        },
        0.8,
        Enum.EasingStyle.Exponential
    )
    
    -- Spin the spinner
    task.spawn(function()
        while outerCircle and outerCircle.Parent do
            outerCircle.Rotation = outerCircle.Rotation + 1
            task.wait()
        end
    end)
    
    return loadingScreen
end

-- Function to load the main script
local function loadMainScript()
    if getgenv().SCRIPT_LOADED then
        warn("Script already loaded!")
        return true
    end
    
    local coreGui = game:GetService("CoreGui")
    
    -- Create loading screen
    local loadingScreen = createLoadingScreen()
    
    -- Wait a moment for animation
    task.wait(0.5)
    
    -- Execute the main script
    local success, err = pcall(function()
        loadstring(game:HttpGet(MAIN_SCRIPT_URL))()
    end)
    
    -- Animate exit and clean up
    task.wait(0.5)
    
    if loadingScreen then
        local mainContainer = loadingScreen:FindFirstChildOfClass("Frame")
        if mainContainer then
            Utils.Tween(
                mainContainer,
                {
                    Position = UDim2.new(0.5, 0, 0.5, 100),
                    BackgroundTransparency = 1
                },
                0.7,
                Enum.EasingStyle.Exponential,
                Enum.EasingDirection.In
            )
        end
        
        task.delay(0.7, function()
            loadingScreen:Destroy()
            SetBlur(false)
        end)
    end
    
    if success then
        getgenv().SCRIPT_LOADED = true
        
        -- Create success notification (matching UI style)
        task.wait(0.3)
        local successScreen = Instance.new("ScreenGui")
        successScreen.Name = "SuccessScreen"
        successScreen.ResetOnSpawn = false
        successScreen.Parent = coreGui
        
        local successContainer = Instance.new("Frame")
        successContainer.Size = Configuration.Window.Size
        successContainer.Position = UDim2.new(0.5, 0, 0.5, 0)
        successContainer.AnchorPoint = Vector2.new(0.5, 0.5)
        successContainer.BackgroundColor3 = Configuration.Colors.Bg
        successContainer.BackgroundTransparency = 0.2
        successContainer.ClipsDescendants = true
        successContainer.Parent = successScreen
        
        Utils.Round(successContainer, 24)
        Utils.Stroke(successContainer, Color3.new(1, 1, 1), 1, 0.92)
        
        -- Content
        local successContent = Instance.new("Frame")
        successContent.Size = UDim2.new(1, 0, 1, 0)
        successContent.BackgroundTransparency = 1
        successContent.Parent = successContainer
        
        -- Success icon
        local successIcon = Instance.new("ImageLabel")
        successIcon.Size = UDim2.fromOffset(100, 100)
        successIcon.Position = UDim2.new(0.5, -50, 0.4, -50)
        successIcon.AnchorPoint = Vector2.new(0.5, 0.5)
        successIcon.Image = Icons.CheckCircle
        successIcon.ImageColor3 = Configuration.Colors.StatusSuccess
        successIcon.BackgroundTransparency = 1
        successIcon.Parent = successContent
        
        -- Success text
        local successText = Instance.new("TextLabel")
        successText.Size = UDim2.new(0.8, 0, 0, 40)
        successText.Position = UDim2.new(0.5, 0, 0.7, 0)
        successText.AnchorPoint = Vector2.new(0.5, 0.5)
        successText.BackgroundTransparency = 1
        successText.Text = "SCRIPT LOADED!"
        successText.TextColor3 = Configuration.Colors.StatusSuccess
        successText.TextSize = 20
        successText.Font = Enum.Font.GothamBold
        successText.Parent = successContent
        
        -- Subtext
        local subText = Instance.new("TextLabel")
        subText.Size = UDim2.new(0.8, 0, 0, 30)
        subText.Position = UDim2.new(0.5, 0, 0.85, 0)
        subText.AnchorPoint = Vector2.new(0.5, 0.5)
        subText.BackgroundTransparency = 1
        subText.Text = "Ready to use"
        subText.TextColor3 = Configuration.Colors.TextSec
        subText.TextSize = 14
        subText.Font = Enum.Font.Gotham
        subText.Parent = successContent
        
        -- Animate entrance
        successContainer.Position = UDim2.new(0.5, 0, 0.5, 100)
        successContainer.BackgroundTransparency = 1
        Utils.Tween(
            successContainer,
            {
                Position = UDim2.new(0.5, 0, 0.5, 0),
                BackgroundTransparency = 0.2
            },
            0.8,
            Enum.EasingStyle.Exponential
        )
        
        -- Auto-close after delay
        task.delay(2, function()
            if successContainer then
                Utils.Tween(
                    successContainer,
                    {
                        Position = UDim2.new(0.5, 0, 0.5, 100),
                        BackgroundTransparency = 1
                    },
                    0.7,
                    Enum.EasingStyle.Exponential,
                    Enum.EasingDirection.In
                )
                
                task.delay(0.7, function()
                    successScreen:Destroy()
                end)
            end
        end)
        
        return true
    else
        warn("Failed to load main script:", err)
        
        -- Create error notification (matching UI style)
        local errorScreen = Instance.new("ScreenGui")
        errorScreen.Name = "ErrorScreen"
        errorScreen.ResetOnSpawn = false
        errorScreen.Parent = coreGui
        
        local errorContainer = Instance.new("Frame")
        errorContainer.Size = Configuration.Window.Size
        errorContainer.Position = UDim2.new(0.5, 0, 0.5, 0)
        errorContainer.AnchorPoint = Vector2.new(0.5, 0.5)
        errorContainer.BackgroundColor3 = Configuration.Colors.Bg
        errorContainer.BackgroundTransparency = 0.2
        errorContainer.ClipsDescendants = true
        errorContainer.Parent = errorScreen
        
        Utils.Round(errorContainer, 24)
        Utils.Stroke(errorContainer, Configuration.Colors.Error, 1, 0.3)
        
        -- Content
        local errorContent = Instance.new("Frame")
        errorContent.Size = UDim2.new(1, 0, 1, 0)
        errorContent.BackgroundTransparency = 1
        errorContent.Parent = errorContainer
        
        -- Error icon
        local errorIcon = Instance.new("ImageLabel")
        errorIcon.Size = UDim2.fromOffset(80, 80)
        errorIcon.Position = UDim2.new(0.5, -40, 0.3, -40)
        errorIcon.AnchorPoint = Vector2.new(0.5, 0.5)
        errorIcon.Image = Icons.ErrorFolder
        errorIcon.ImageColor3 = Configuration.Colors.Error
        errorIcon.BackgroundTransparency = 1
        errorIcon.Parent = errorContent
        
        -- Error text
        local errorText = Instance.new("TextLabel")
        errorText.Size = UDim2.new(0.8, 0, 0, 60)
        errorText.Position = UDim2.new(0.5, 0, 0.6, 0)
        errorText.AnchorPoint = Vector2.new(0.5, 0.5)
        errorText.BackgroundTransparency = 1
        errorText.Text = "LOAD FAILED\n" .. tostring(err):sub(1, 100)
        errorText.TextColor3 = Configuration.Colors.Error
        errorText.TextSize = 14
        errorText.Font = Enum.Font.GothamMedium
        errorText.TextWrapped = true
        errorText.Parent = errorContent
        
        -- Close button
        local closeBtn = Instance.new("TextButton")
        closeBtn.Size = UDim2.new(0, 120, 0, 40)
        closeBtn.Position = UDim2.new(0.5, -60, 0.85, -20)
        closeBtn.AnchorPoint = Vector2.new(0.5, 0.5)
        closeBtn.BackgroundColor3 = Configuration.Colors.Error
        closeBtn.Text = "CLOSE"
        closeBtn.TextColor3 = Color3.new(1, 1, 1)
        closeBtn.Font = Enum.Font.GothamBold
        closeBtn.TextSize = 14
        closeBtn.AutoButtonColor = false
        closeBtn.Parent = errorContent
        Utils.Round(closeBtn, 8)
        
        closeBtn.MouseButton1Click:Connect(function()
            errorScreen:Destroy()
        end)
        
        -- Hover effect
        closeBtn.MouseEnter:Connect(function()
            Utils.Tween(closeBtn, {BackgroundColor3 = Configuration.Colors.Error:Lerp(Color3.new(1, 1, 1), 0.1)}, 0.2)
        end)
        
        closeBtn.MouseLeave:Connect(function()
            Utils.Tween(closeBtn, {BackgroundColor3 = Configuration.Colors.Error}, 0.2)
        end)
        
        -- Animate entrance
        errorContainer.Position = UDim2.new(0.5, 0, 0.5, 100)
        errorContainer.BackgroundTransparency = 1
        Utils.Tween(
            errorContainer,
            {
                Position = UDim2.new(0.5, 0, 0.5, 0),
                BackgroundTransparency = 0.2
            },
            0.8,
            Enum.EasingStyle.Exponential
        )
        
        -- Auto-close after 10 seconds
        task.delay(10, function()
            if errorScreen and errorScreen.Parent then
                errorScreen:Destroy()
            end
        end)
        
        return false
    end
end

local function Build()
	local parent = game:GetService("CoreGui")
	local old = parent:FindFirstChild(Configuration.ScreenGuiName)
	if old then
		old:Destroy()
	end
	local screen = Instance.new("ScreenGui")
	screen.Name = Configuration.ScreenGuiName
	screen.ResetOnSpawn = false
	screen.Parent = parent
	local overlay = Instance.new("Frame")
	overlay.Size = UDim2.fromScale(1, 1)
	overlay.BackgroundColor3 = Color3.new(0, 0, 0)
	overlay.BackgroundTransparency = 1
	overlay.Parent = screen
	Utils.Tween(overlay, {BackgroundTransparency = 1}, 1)
	SetBlur(true)
	local main = Instance.new("Frame")
	main.Size = Configuration.Window.Size
	main.Position = UDim2.new(0.5, 0, 0.5, 60)
	main.AnchorPoint = Vector2.new(0.5, 0.5)
	main.BackgroundColor3 = Configuration.Colors.Bg
	main.BackgroundTransparency = 0.2
	main.ClipsDescendants = true
	main.Parent = screen
	Utils.Round(main, 24)
	Utils.Stroke(main, Color3.new(1, 1, 1), 1, 0.92)
	local glass = Instance.new("Frame")
	glass.Size = UDim2.fromScale(1, 1)
	glass.BackgroundColor3 = Color3.new(1, 1, 1)
	glass.BackgroundTransparency = 0.985
	glass.ZIndex = 0
	glass.Parent = main
	Utils.Round(glass, 24)
	local bar = Instance.new("Frame")
	bar.Size = UDim2.new(1, 0, 0, 54)
	bar.BackgroundTransparency = 1
	bar.Parent = main
	local dots = Instance.new("Frame")
	dots.Size = UDim2.new(0, 54, 0, 12)
	dots.Position = UDim2.new(0, 20, 0.5, 0)
	dots.AnchorPoint = Vector2.new(0, 0.5)
	dots.BackgroundTransparency = 1
	dots.Parent = bar
	local dColors = {
		Configuration.Colors.TrafficRed,
		Configuration.Colors.TrafficYellow,
		Configuration.Colors.TrafficGreen
	}
	for i, c in ipairs(dColors) do
		local d = Instance.new("Frame")
		d.Size = UDim2.fromOffset(12, 12)
		d.Position = UDim2.fromOffset((i - 1) * 18, 0)
		d.BackgroundColor3 = c
		d.BorderSizePixel = 0
		d.Parent = dots
		Utils.Round(d, 6)
	end
	local titleText = Instance.new("TextLabel")
	titleText.Size = UDim2.new(1, 0, 1, 0)
	titleText.Text = "KEY SYSTEM"
	titleText.TextColor3 = Color3.new(1, 1, 1)
	titleText.TextTransparency = 0.7
	titleText.TextSize = 10
	titleText.Font = Enum.Font.GothamBold
	titleText.BackgroundTransparency = 1
	titleText.Parent = bar
	local content = Instance.new("ScrollingFrame")
	content.Size = UDim2.new(1, 0, 1, -54)
	content.Position = UDim2.new(0, 0, 0, 54)
	content.BackgroundTransparency = 1
	content.ScrollBarThickness = 0
	content.CanvasSize = UDim2.new(0, 0, 0, 440)
	content.Parent = main
	local list = Instance.new("UIListLayout")
	list.Padding = UDim.new(0, 24)
	list.HorizontalAlignment = Enum.HorizontalAlignment.Center
	list.Parent = content
	local pad = Instance.new("UIPadding")
	pad.PaddingTop = UDim.new(0, 5)
	pad.Parent = content
	local logoContainer = Instance.new("Frame")
	logoContainer.Size = UDim2.fromOffset(80, 80)
	logoContainer.BackgroundColor3 = Configuration.Colors.Primary
	logoContainer.Parent = content
	Utils.Round(logoContainer, 20)
	local grad = Instance.new("UIGradient")
	grad.Color = ColorSequence.new(Configuration.Colors.Primary, Configuration.Colors.PrimaryDark)
	grad.Rotation = 45
	grad.Parent = logoContainer
	local sIcon = Instance.new("ImageLabel")
	sIcon.Size = UDim2.fromScale(1, 1)
	sIcon.Position = UDim2.fromScale(0.5, 0.5)
	sIcon.AnchorPoint = Vector2.new(0.5, 0.5)
	sIcon.Image = Icons.JunkieNewIcon
	sIcon.ScaleType = Enum.ScaleType.Fit
	sIcon.BackgroundTransparency = 1
	sIcon.Parent = logoContainer
	local titleArea = Instance.new("Frame")
	titleArea.Size = UDim2.new(1, 0, 0, 44)
	titleArea.BackgroundTransparency = 1
	titleArea.Parent = content
	local mainTitle = Instance.new("TextLabel")
	mainTitle.Size = UDim2.new(1, 0, 0, 26)
	mainTitle.Text = "Luna Scripts"
	mainTitle.TextColor3 = Color3.new(1, 1, 1)
	mainTitle.TextSize = 26
	mainTitle.Font = Enum.Font.GothamBold
	mainTitle.BackgroundTransparency = 1
	mainTitle.Parent = titleArea
	local subTitle = Instance.new("TextLabel")
	subTitle.Size = UDim2.new(1, 0, 0, 16)
	subTitle.Position = UDim2.fromOffset(0, 28)
	subTitle.Text = "discord.gg/zbzybpHqU"
	subTitle.TextColor3 = Configuration.Colors.TextSec
	subTitle.TextSize = 13
	subTitle.Font = Enum.Font.Gotham
	subTitle.BackgroundTransparency = 1
	subTitle.Parent = titleArea
	local statusCard = Instance.new("Frame")
	statusCard.Size = UDim2.new(0, 280, 0, 68)
	statusCard.BackgroundColor3 = Color3.new(1, 1, 1)
	statusCard.BackgroundTransparency = 0.96
	statusCard.Parent = content
	Utils.Round(statusCard, 16)
	local sStroke = Utils.Stroke(statusCard, Color3.new(1, 1, 1), 1, 0.95)
	local sIconBg = Instance.new("Frame")
	sIconBg.Size = UDim2.fromOffset(42, 42)
	sIconBg.Position = UDim2.new(0, 14, 0.5, 0)
	sIconBg.AnchorPoint = Vector2.new(0, 0.5)
	sIconBg.BackgroundColor3 = Configuration.Colors.StatusIdle
	sIconBg.BackgroundTransparency = 0.9
	sIconBg.Parent = statusCard
	Utils.Round(sIconBg, 21)
	local sImg = Instance.new("ImageLabel")
	sImg.Size = UDim2.fromScale(0.5, 0.5)
	sImg.Position = UDim2.fromScale(0.5, 0.5)
	sImg.AnchorPoint = Vector2.new(0.5, 0.5)
	sImg.Image = Icons.Lock
	sImg.ImageColor3 = Configuration.Colors.StatusIdle
	sImg.BackgroundTransparency = 1
	sImg.Parent = sIconBg
	local sLabel = Instance.new("TextLabel")
	sLabel.Size = UDim2.new(1, -70, 0, 14)
	sLabel.Position = UDim2.fromOffset(70, 16)
	sLabel.Text = "CURRENT STATUS"
	sLabel.TextColor3 = Configuration.Colors.TextMuted
	sLabel.TextSize = 10
	sLabel.Font = Enum.Font.GothamBold
	sLabel.TextXAlignment = Enum.TextXAlignment.Left
	sLabel.BackgroundTransparency = 1
	sLabel.Parent = statusCard
	local sValue = Instance.new("TextLabel")
	sValue.Size = UDim2.new(1, -70, 0, 20)
	sValue.Position = UDim2.fromOffset(70, 32)
	sValue.Text = "No key detected"
	sValue.TextColor3 = Configuration.Colors.StatusIdle
	sValue.TextSize = 15
	sValue.Font = Enum.Font.GothamMedium
	sValue.TextXAlignment = Enum.TextXAlignment.Left
	sValue.BackgroundTransparency = 1
	sValue.Parent = statusCard
	local inputFrame = Instance.new("Frame")
	inputFrame.Size = UDim2.new(0, 280, 0, 52)
	inputFrame.BackgroundColor3 = Color3.new(1, 1, 1)
	inputFrame.BackgroundTransparency = 0.975
	inputFrame.Parent = content
	Utils.Round(inputFrame, 14)
	local iStroke = Utils.Stroke(inputFrame, Color3.new(1, 1, 1), 1, 0.95)
	local kIcon = Instance.new("ImageLabel")
	kIcon.Size = UDim2.fromOffset(18, 18)
	kIcon.Position = UDim2.new(0, 14, 0.5, 0)
	kIcon.AnchorPoint = Vector2.new(0, 0.5)
	kIcon.Image = Icons.Key
	kIcon.ImageColor3 = Configuration.Colors.TextMuted
	kIcon.BackgroundTransparency = 1
	kIcon.Parent = inputFrame
	local box = Instance.new("TextBox")
	box.Size = UDim2.new(1, -85, 1, 0)
	box.Position = UDim2.fromOffset(45, 0)
	box.Text = ""
	box.PlaceholderText = "Enter your key..."
	box.TextColor3 = Color3.new(1, 1, 1)
	box.TextSize = 14
	box.Font = Enum.Font.Gotham
	box.BackgroundTransparency = 1
	box.TextXAlignment = Enum.TextXAlignment.Left
	box.Parent = inputFrame
	local paste = Instance.new("ImageButton")
	paste.Size = UDim2.fromOffset(18, 18)
	paste.Position = UDim2.new(1, -14, 0.5, 0)
	paste.AnchorPoint = Vector2.new(1, 0.5)
	paste.Image = Icons.Copy
	paste.ImageColor3 = Configuration.Colors.TextMuted
	paste.BackgroundTransparency = 1
	paste.Parent = inputFrame
	local btnRow = Instance.new("Frame")
	btnRow.Size = UDim2.new(0, 280, 0, 50)
	btnRow.BackgroundTransparency = 1
	btnRow.Parent = content
	local redeem = Instance.new("TextButton")
	redeem.Size = UDim2.new(0.5, -8, 1, 0)
	redeem.BackgroundColor3 = Configuration.Colors.Primary
	redeem.Text = "Redeem"
	redeem.TextColor3 = Color3.new(1, 1, 1)
	redeem.Font = Enum.Font.GothamBold
	redeem.TextSize = 14
	redeem.AutoButtonColor = false
	redeem.Parent = btnRow
	Utils.Round(redeem, 14)
	local getKey = Instance.new("TextButton")
	getKey.Size = UDim2.new(0.5, -8, 1, 0)
	getKey.Position = UDim2.new(0.5, 8, 0, 0)
	getKey.BackgroundColor3 = Color3.new(1, 1, 1)
	getKey.BackgroundTransparency = 0.955
	getKey.Text = "Get Key"
	getKey.TextColor3 = Color3.new(1, 1, 1)
	getKey.Font = Enum.Font.GothamBold
	getKey.TextSize = 14
	getKey.AutoButtonColor = false
	getKey.Parent = btnRow
	Utils.Round(getKey, 14)
	Utils.Stroke(getKey, Color3.new(1, 1, 1), 1, 0.94)
	local function ApplyHover(btn)
		local baseColor = btn.BackgroundColor3
		btn.MouseEnter:Connect(
			function()
				Utils.Tween(
					btn,
					{
						BackgroundColor3 = baseColor:Lerp(Color3.new(1, 1, 1), 0.1)
					},
					0.2
				)
				Utils.Tween(
					btn,
					{
						Size = UDim2.new(btn.Size.X.Scale, btn.Size.X.Offset + 4, btn.Size.Y.Scale, btn.Size.Y.Offset + 2)
					},
					0.2
				)
			end
		)
		btn.MouseLeave:Connect(
			function()
				Utils.Tween(btn, {BackgroundColor3 = baseColor}, 0.2)
				Utils.Tween(
					btn,
					{
						Size = UDim2.new(btn.Size.X.Scale, btn.Size.X.Offset - 4, btn.Size.Y.Scale, btn.Size.Y.Offset - 2)
					},
					0.2
				)
			end
		)
	end
	ApplyHover(redeem)
	ApplyHover(getKey)
	box.Focused:Connect(
		function()
			Utils.Tween(iStroke, {Transparency = 0.5, Thickness = 1.2}, 0.3)
		end
	)
	box.FocusLost:Connect(
		function()
			Utils.Tween(iStroke, {Transparency = 0.95, Thickness = 1}, 0.3)
		end
	)
	local spinConnection
	local dotsThread
	local function SetStatus(state)
		if spinConnection then
			spinConnection:Disconnect()
			spinConnection = nil
			sImg.Rotation = 0
		end
		if dotsThread then
			task.cancel(dotsThread)
			dotsThread = nil
		end
		local color = Configuration.Colors.StatusIdle
		local icon = Icons.Lock
		local text = "No key detected"
		if state == "verifying" then
			color = Configuration.Colors.StatusVerifying
			icon = Icons.Loading
			text = "Verifying access"
			spinConnection =
				RunService.Heartbeat:Connect(
				function(dt)
					if not sImg or not sImg.Parent then
						if spinConnection then
							spinConnection:Disconnect()
						end
						spinConnection = nil
						return
					end
					sImg.Rotation = (sImg.Rotation + dt * 360) % 360
				end
			)
			local dots = {".", "..", "...", ""}
			local i = 1
			dotsThread =
				task.spawn(
				function()
					while sValue and sValue.Parent do
						if not sValue.Text:find("Verifying access", 1, true) then
							break
						end
						sValue.Text = text .. dots[i]
						i = (i % #dots) + 1
						task.wait(0.45)
					end
				end
			)
		elseif state == "success" then
			color = Configuration.Colors.StatusSuccess
			icon = Icons.CheckCircle
			text = "Access Granted"
		elseif state == "error" then
			color = Configuration.Colors.StatusError
			icon = Icons.XCircle
			text = "Invalid Key"
		end
		Utils.Tween(sValue, {TextColor3 = color}, 0.35)
		Utils.Tween(sImg, {ImageColor3 = color}, 0.35)
		Utils.Tween(sIconBg, {BackgroundColor3 = color}, 0.35)
		sValue.Text = text
		sImg.Image = icon
	end
	redeem.MouseButton1Click:Connect(
		function()
			local key = box.Text:upper()
			SetStatus("verifying")
			redeem.Text = "..."
			redeem.Active = false
            
            -- IMPORTANT: Wait a moment before checking to prevent race conditions
            task.wait(0.1)
            
            local result = Junkie.check_key(key)
			redeem.Active = true
			redeem.Text = "Redeem"
            
			if not result then
				SetStatus("error")
				ToastSystem.Create(screen, "API request failed", "error")
				return
			end
            
			if result.valid then
                saveVerifiedKey(key)
                getgenv().SCRIPT_KEY = key
                SetStatus("success")
                ToastSystem.Create(screen, "Access granted!", "success")
                
                -- Load the main script after successful key verification
                task.wait(0.8)
                SetBlur(false)
                Utils.Tween(
                    main,
                    {
                        Position = UDim2.new(0.5, 0, 0.5, 100),
                        BackgroundTransparency = 1
                    },
                    0.7,
                    Enum.EasingStyle.Exponential,
                    Enum.EasingDirection.In
                )
                task.delay(
                    0.7,
                    function()
                        screen:Destroy()
                        -- Load the main script
                        loadMainScript()
                    end
                )
			else
				SetStatus("error")
				ToastSystem.Create(screen, result.message or "Invalid key", "error")
			end
		end
	)
	getKey.MouseButton1Click:Connect(
		function()
			setclipboard(Junkie.get_key_link())
			ToastSystem.Create(screen, "Key link has been copied to clipboard", "success")
		end
	)
	paste.MouseButton1Click:Connect(
		function()
			ToastSystem.Create(screen, "Paste functionality not supported in Roblox (security reasons)", "warning")
		end
	)
	main.Position = UDim2.new(0.5, 0, 0.5, 100)
	main.BackgroundTransparency = 1
	Utils.Tween(
		main,
		{
			Position = UDim2.new(0.5, 0, 0.5, 0),
			BackgroundTransparency = 0.2
		},
		1,
		Enum.EasingStyle.Exponential
	)
	local dragging, dragStart, startPos
	bar.InputBegan:Connect(
		function(input)
			if input.UserInputType == Enum.UserInputType.MouseButton1 then
				dragging = true
				dragStart = input.Position
				startPos = main.Position
			end
		end
	)
	UserInputService.InputChanged:Connect(
		function(input)
			if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
				local delta = input.Position - dragStart
				main.Position =
					UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
			end
		end
	)
	UserInputService.InputEnded:Connect(
		function(input)
			if input.UserInputType == Enum.UserInputType.MouseButton1 then
				dragging = false
			end
		end
	)
	return screen
end

-- Main execution flow
print("Checking for saved key...")
local savedKey = loadVerifiedKey()

if savedKey then
    print("Found saved key:", savedKey)
    
    -- Validate the saved key first
    local result = Junkie.check_key(savedKey)
    
    if result and result.valid then
        print("Saved key is valid!")
        getgenv().SCRIPT_KEY = savedKey
        
        -- Only load if explicitly KEY_VALID or KEYLESS
        if result.message == "KEY_VALID" or result.message == "KEYLESS" then
            print("Loading main script...")
            loadMainScript()
        else
            print("Key valid but not authorized for script. Showing UI...")
            Build()
        end
    else
        print("Saved key is invalid. Clearing...")
        clearSavedKey()
        Build()
    end
elseif getgenv().SCRIPT_KEY then
    print("Found SCRIPT_KEY in getgenv:", getgenv().SCRIPT_KEY)
    
    -- Validate the getgenv key
    local result = Junkie.check_key(getgenv().SCRIPT_KEY)
    
    if result and result.valid then
        print("getgenv key is valid!")
        
        if result.message == "KEY_VALID" or result.message == "KEYLESS" then
            print("Loading main script...")
            loadMainScript()
        else
            print("Key valid but not authorized for script. Showing UI...")
            Build()
        end
    else
        print("getgenv key is invalid. Showing UI...")
        Build()
    end
else
    print("No keys found. Showing UI...")
    Build()
end

-- Add a safety check to prevent accidental loading
task.spawn(function()
    task.wait(2) -- Wait 2 seconds
    if not getgenv().SCRIPT_LOADED and not getgenv().SCRIPT_KEY then
        print("No valid key found after 2 seconds. Showing UI...")
        if not game:GetService("CoreGui"):FindFirstChild(Configuration.ScreenGuiName) then
            Build()
        end
    end
end)

print("Luna Scripts Key System - Ready")
